# 專案問題與風險追蹤

**更新日期**: 2025-12-11

---

## 🔴 當前緊急問題

### [CRITICAL] AI 無法達成利潤目標

**問題**：用戶要求「24月，3000萬預算，賺800萬」，AI 實際產生 -4000萬虧損

**影響**：核心功能完全失效

**測試結果**：
- 測試 #1: 累積利潤 -7000萬（預算超標2.24倍）
- 測試 #2: 累積利潤未知（預算只有10%）
- 測試 #3: 累積利潤 **-4000萬**（預算 87.5%）

**根本原因**：
1. AI 不理解任務是「計算損益表」而非「填表格」
2. AI 忽略人力成本（2400萬）、渠道費（33%）等
3. AI 導入後不驗證結果（看不到虧損）
4. AI 優先考慮行業基準而非達成目標

**嘗試的解決方案**（5 次，均失敗）：
- ❌ 加入完整成本公式 → AI 仍忽略
- ❌ 目標導向工作流程 → AI 說會做但不執行
- 🟡 重構優先級系統 → 預算改善但利潤仍錯
- 🟡 單位說明強化 → 待測試
- ❌ 升級模型 → 不支持 function calling

**下一步方向**：
1. 前端自動驗證：導入後強制調用 get_current_state 回傳給 AI
2. 合併工具：import_complete_plan 直接返回實際利潤
3. 更換 AI 服務（Claude 3.5）
4. 降級目標（改為多輪引導）

---

## 🟡 次要問題

### [AI] 不會執行驗證工具
- AI 會「說」要驗證，但不調用 `get_current_state`
- 看不到結果就無法觸發迭代優化

### [AI] 單位理解問題
- 「3000萬」有時被理解為 3,000,000（差10倍）
- 已加入詳細說明，待驗證

---

## ✅ 已解決的問題

### AI 完全無回應（12/10）
- **原因**：缺少 .env.local、SDK 版本衝突
- **解決**：降級到 ai@3.3.44、配置環境變數

### 24 個月導入崩潰（12/11）
- **原因**：系統預設只支援 12 個月
- **解決**：使用 importData 批量導入

### 留存模型加載失敗（12/11）
- **原因**：JSON 字段名錯誤（anchors vs retention）
- **解決**：兼容兩種字段名

---

## 核心文件速查

### 修改 AI 行為
- **`lib/ai/system-prompt.ts`** (750行) - AI 的指令手冊

### 修改工具執行
- **`components/ai-chat-modal.tsx`** (360行) - 前端工具執行邏輯

### 修改 AI 模型
- **`app/api/chat/route.ts`** Line 176 - 模型設定

### 財務計算邏輯
- **`lib/finance-utils.ts`** Line 332-438 - 損益表計算

---

## 風險評估

| 風險 | 等級 | 說明 |
|------|------|------|
| AI 無法達成目標 | 🔴 高 | 核心功能受阻，可能需要架構重設計 |
| API 成本超支 | 🟡 中 | 多次測試消耗 token，需監控 |
| 用戶體驗不佳 | 🟡 中 | 多次失敗會降低信任 |

---

**建議行動**：
1. 立即測試最新版本（已加入單位說明和優先級）
2. 如仍失敗，實作前端強制驗證機制
3. 考慮降級為多輪引導模式