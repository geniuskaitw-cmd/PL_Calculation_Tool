# 專案開發進度報告

**更新日期**: 2025-12-11

---

## 當前狀態：🔴 AI 計算準確性問題（嚴重）

### 核心問題

**需求**：「RPG 遊戲，24 個月預算 3000 萬，想賺 800 萬淨利」

**預期**：
- 總預算 = 30,000,000
- 累積利潤 = 8,000,000

**實際**：
- 總預算 ≈ 26,250,000（87.5%）
- 累積利潤 = **-40,000,000**（❌ 巨虧）

### 問題根源

1. **AI 不理解「損益表」是目標**
   - AI 以為任務是「填表格」
   - 實際應該是「讓損益表的累積利潤 = 800萬」

2. **AI 忽略成本計算**
   - 人力成本：5人×20萬×24月 = 2400萬（幾乎等於全部預算）
   - 渠道費：佔流水的 33%（最大成本）
   - 退款+稅：佔流水的 15%

3. **AI 不會驗證結果**
   - 導入後不調用 `get_current_state` 檢查
   - 看不到 accProfit = -4000 萬
   - 直接報告「成功」

4. **AI 優先級錯誤**
   - 優先考慮「符合 RPG 行業基準」（ARPDAU $5）
   - 應該優先考慮「達成 800 萬利潤」（可能需要 ARPDAU $20）

---

## 已執行的修復嘗試（5 次）

| # | 日期 | 修復內容 | 效果 |
|---|------|----------|------|
| 1 | 12/10 | 加入完整成本公式 | ❌ AI 仍忽略 |
| 2 | 12/11 | 目標導向工作流程（10步） | ❌ 說會做但不執行 |
| 3 | 12/11 | 重構優先級系統 | 🟡 預算改善到 87.5% |
| 4 | 12/11 | 參數範圍明確化 | 🟡 待測試 |
| 5 | 12/11 | 單位說明強化 | 🟡 待測試 |

---

## 核心文件位置

### 後端 API
- **`app/api/chat/route.ts`**
  - Line 176: 模型選擇（gpt-4o）
  - Line 10-153: 6 個工具定義

### AI 系統提示詞
- **`lib/ai/system-prompt.ts`** (約 750 行)
  - Line 1-88: 核心原則與優先級
  - Line 90-270: 財務公式與參數權限
  - Line 272-650: 工作流程與計算範例

### 前端對話框
- **`components/ai-chat-modal.tsx`**
  - Line 111-161: import_complete_plan 執行邏輯
  - Line 230-273: function_call 解析與執行

### 財務計算
- **`lib/finance-utils.ts`**
  - Line 332-438: calculatePLData（損益表計算）

---

## 已實作的功能

### ✅ 基礎功能（可用）
- AI 對話
- 單一參數更新（updateMonthlyPlan）
- 留存模型套用（applyPreset）

### ✅ 進階工具（已實作）
- get_current_state（讀取狀態）
- import_complete_plan（導入 24 月計畫）
- update_multiple_months（批量更新）

### 🔴 目標功能（失敗）
- **目標導向規劃**：「24月，3000萬，賺800萬」→ 目前產生 -4000萬虧損

---

## 可能的解決方向

1. **前端強制驗證**：導入後自動調用 get_current_state 回傳給 AI
2. **合併工具**：import_complete_plan 返回實際 accProfit
3. **更換模型**：嘗試 Claude 或其他 AI
4. **簡化任務**：改為多輪引導，不要求一次完成

---

**當前優先級**：解決 AI 計算問題 > 其他所有功能
